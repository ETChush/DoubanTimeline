# JAV 影片管理功能说明

## 已完成的功能

### 1. 数据库模型
- ✅ 创建了 `JavMovie` 数据模型
- ✅ 支持番号、标题、封面、演员、发行日期、制作商等完整信息
- ✅ 支持收藏功能 (`IsFavorite` 字段)
- ✅ 自动数据库迁移

### 2. 页面导航
- ✅ 在豆瓣页面顶部添加了标签导航（豆瓣/JAV）
- ✅ 创建了独立的 JAV 影片管理页面

### 3. 核心功能
- ✅ 添加 JAV 影片（输入番号自动抓取信息）
- ✅ 删除 JAV 影片
- ✅ 收藏/取消收藏功能（小心心图标）
- ✅ "我的最爱"筛选功能
- ✅ 按观看日期时间轴分组展示
- ✅ 自动下载封面图片到本地

### 4. Python 爬虫集成
- ✅ 修改了 `javbus_crawler.py` 支持 JSON 输出
- ✅ Go 后端调用 Python 爬虫获取影片信息
- ✅ UTF-8 编码支持（修复中文乱码问题）

## 使用说明

### 启动服务器
```bash
cd D:\aa\douban-jav
douban-timeline.exe
```

然后访问：
- 豆瓣页面：http://localhost:8080/
- JAV 页面：http://localhost:8080/jav

### 添加 JAV 影片
1. 访问 JAV 页面
2. 点击右上角"+ 添加影片"按钮
3. 输入番号（例如：SSIS-001）
4. 选择观看日期（默认为今天）
5. 点击"添加"按钮

系统会自动：
- 调用 Python 爬虫从 javbus.com 抓取影片信息
- 下载封面图片到本地 images/ 目录
- 保存到数据库

### 收藏功能
- 悬停在影片卡片上，点击小心心图标即可收藏
- 点击右上角"♡ 我的最爱"按钮查看收藏的影片
- 再次点击小心心图标取消收藏

### 删除影片
- 悬停在影片卡片上，点击"删除"按钮
- 确认删除后，会同时删除数据库记录和本地图片

## 已修复的问题

### 问题 1：点击豆瓣标签报错
**原因**：豆瓣页面模板使用了 `FavoritesOnly` 字段，但 `PageData` 结构体没有这个字段

**解决方案**：在 `PageData` 结构体中添加了 `FavoritesOnly` 字段

### 问题 2：JAV 页面中文乱码
**原因**：Python 在 Windows 环境下输出 UTF-8 编码有问题

**解决方案**：
1. 修改了 Python 脚本，在输出 JSON 前设置标准输出为 UTF-8 编码
2. 在 Go 中调用 Python 时设置环境变量 `PYTHONIOENCODING=utf-8`

### 问题 3：JAV 卡片布局和封面显示
**原因**：JAV 卡片没有使用和豆瓣一样的 7:10 封面比例

**解决方案**：
1. 修改了模板，JAV 卡片使用相同的 `movie-poster` 类
2. 添加了 CSS 样式确保封面图片正确显示
3. 封面图片使用 `object-fit: cover` 保持比例

## 技术细节

### 数据流程
```
用户输入番号
    ↓
Go 后端调用 Python 爬虫
    ↓
Python 从 javbus.com 抓取信息
    ↓
Python 输出 JSON 格式数据
    ↓
Go 解析 JSON 并保存到数据库
    ↓
下载封面图片到本地
    ↓
显示在时间轴页面
```

### 文件结构
```
D:\aa\douban-jav
├── main.go                      # 主程序（包含 JAV 路由和处理器）
├── javbus_crawler.py            # Python 爬虫（支持 JSON 输出）
├── templates/
│   ├── index.html              # 豆瓣页面（带导航栏）
│   └── jav.html                # JAV 页面
├── static/
│   └── style.css               # 样式表（包含 JAV 专用样式）
├── douban_timeline.db          # SQLite 数据库
└── images/                      # 图片存储目录
```

## 注意事项

1. **Python 依赖**：
   - 确保已安装 Python 3
   - 需要安装依赖：`pip install httpx aiofiles lxml`

2. **网络访问**：
   - 爬虫需要访问 javbus.com
   - 如果需要代理，可以修改 `fetchJavInfoFromPython` 函数添加 `--proxy` 参数

3. **编码问题**：
   - 已修复 Windows 下的 UTF-8 编码问题
   - 如果仍有乱码，检查控制台编码设置

4. **数据库清理**：
   - 如果数据库中有损坏的记录，可以手动删除：
   ```bash
   go run main.go
   # 然后通过 Web 界面删除
   ```

## 待优化功能（可选）

- [ ] 添加影片搜索功能
- [ ] 支持批量添加
- [ ] 添加更多筛选条件（演员、制作商等）
- [ ] 支持导出 JAV 影片列表为 JSON
- [ ] 添加图片懒加载优化性能

## 测试建议

1. 测试添加影片：尝试添加不同番号（有码/无码）
2. 测试收藏功能：收藏几部影片，然后查看"我的最爱"
3. 测试删除功能：删除一部影片，确认图片也被删除
4. 测试编码：添加日文标题的影片，确认显示正常
5. 测试布局：在不同屏幕尺寸下查看响应式布局
